# references

https://stackoverflow.com/questions/33835124/c-how-to-mount-a-regular-filesystem-created-with-mkfs-using-mount2

https://linux.die.net/man/2/mount

https://linux.die.net/man/2/umount
# 虚拟文件系统方案

## 方案说明

## 需求分析
    虚拟文件系统能够给用户提供在大量小文件存储需求下的高效文件存储服务
- 文件创建
    1. 文件创建时可接收用户参数，指定虚拟文件系统大小。也可进行默认状态下文件创建，利用该特性进行用户存储配额功能的开发。
    2. 文件创建时，虚拟文件系统存储位置可进行指定，建议采用默认存储位置   
- 虚拟文件系统格式化
    1. 指定虚拟文件系统格式为xfs格式，后续可选择支持多种文件系统格式
- 虚拟文件系统挂载
    1. 虚拟文件系统挂载时，初次挂载可选择读写模式挂载，二次挂载时需考虑挂载模式，在多次挂载时，若仍采用读写模式会导致文件数据不一致问题。
    2. 虚拟文件系统挂载后需向虚拟文件系统服务器进行挂载信息注册，在执行二次挂载前需要进行挂载信息查询。
    3. 虚拟文件系统需要处理在docker虚拟化环境下挂载和恢复方案
- 虚拟文件系统卸载
    1. 虚拟文件系统卸载前需对挂载点进行进行检测
    2. 虚拟文件系统卸载后需在文件系统服务器中取消挂载信息
    3. 虚拟文件系统注册时，需处理卸载顺序和卸载模式
- 虚拟文件系统挂载信息注册与取消
    1. 需要采用clint-server方式进行开发，文件系统挂载时向服务端进行服务注册，卸载时取消虚拟文件挂载信息
    2. client在虚拟文件系统工具处进行服务初始化、服务注册和服务取消
    3. client端采用C语言开发，server采用go开发。
## 功能分析
    主要功能包括虚拟文件系统创建、挂载和卸载
### 功能点说明
-  文件创建
    - [x] 接收用户参数,创建指定大小的虚拟文件
    - [ ] 创建特大文件，TB级别【接口已完成，待测试】
    - [x] 接收用户参数，创建指定用户名的虚拟文件
    - [ ] 创建在默认目录下的用户虚拟文件 
    - [x] 添加文件大小限额功能
    - [ ] 待定功能 
-  文件格式化
    - [x] 格式化虚拟文件为指定文件格式的虚拟文件系统 【当前为xfs文件】  
    - [ ] 后续支持多种虚拟文件系统格式【需测试对比】
    - [ ] 待定功能
-  文件挂载
    - [x] 挂载虚拟文件系统到指定挂载点
    - [ ] 挂载点设置为默认挂载点【用户目录下特定文件夹，待定】
    - [ ] 多次挂载时，挂载模式设置
        - [ ] 首次挂载时可选择读写模式挂载
        - [ ] 二次挂载时需特殊处理挂载模式，防止多读写点挂载造成的文件丢失和混乱
        - [ ] 用户使用模式分析
-  文件挂载信息注册
    - [ ] 注册虚拟文件系统挂载信息，包括文件挂载模式，文件挂载点，挂载文件大小和挂载用户等信息[待定]
    - [ ] client 模式开发，开发语言为C 语言
    - [ ] servre 端采用go语言开发
    - [ ] 其他待定功能
-  文件卸载
    - [x] 文件卸载前检测挂载点
    - [ ] 指定文件卸载模式【force|detach】
    - [ ] 其他待定
-  文件卸载信息注销
    - [ ] 向server端发送挂载信息取消请求，取消虚拟文件系统挂载信息
    - [ ] 其他待定 
-  程序日志方案记录
    - [ ] 采用C日志库进行程序日志采集
-   - [ ] 程序服务端[server go]部分数据库设置时，quota表中以用户为唯一键，保证用户唯一
## 测试方案分析
>   1. 虚拟机进行初期服务测试
>   2. 虚拟化环境下进行服务测试，在星光模拟环境下进行
>   3. 在docker容器环境下，容器销毁与恢复后文件挂载情况处理
>       - [x] 容器销毁对已挂载的文件系统影响
>       - [ ] 容器重启对已挂载的文件系统影响
>       - [ ] 其他待定
## 程序开发计划
    1. 虚拟文件系统开发采用C语言，文件系统服务采用go语言。
    2. 开发前期在虚拟机上进行，后续针对docker虚拟化环境进行服务测试

## 待处理异常

- 文件创建与格式化
    - [ ] 普通用户权限下创建loop设备失败
    - [ ] chmod u+s 后修改文件权限失败，与上一点相矛盾。须进行程序调试
## 现阶段最新方法时采用NFS服务进行中转方案
     文件挂载顺序是有影响的，先执行NFS中挂载操作，后执行外部NFS挂载是无法挂载成功的，先执行外部NFS挂载，再执行NFS内部挂载操作是可以挂载成功的，但是无法确定是否真的将数据写入到虚拟文件块中。